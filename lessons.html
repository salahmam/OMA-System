<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// ğŸ”— Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ)
const firebaseConfig = {
  apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
  authDomain: "oma-system-30813.firebaseapp.com",
  projectId: "oma-system-30813",
  storageBucket: "oma-system-30813.appspot.com",
  messagingSenderId: "905224657062",
  appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
  measurementId: "G-645066LLLP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let editingLessonId = null;

// âœ… ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('userEmail').innerText = user.email;
    await loadDataForInstitute(user.uid);
  } else {
    window.location.href = "login.html";
  }
});

// ğŸ“¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
window.logout = async function () {
  await signOut(auth);
  window.location.href = "login.html";
};

// ğŸ”½ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
async function loadDataForInstitute(instituteId) {
  await Promise.all([
    loadGrades(instituteId),
    loadGroups(instituteId),
    loadTeachers(instituteId),
    loadLessons(instituteId)
  ]);
}

// ğŸ« ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function loadGrades(instituteId) {
  const q = query(collection(db, "grades"), where("instituteId", "==", instituteId));
  const snapshot = await getDocs(q);
  const select = document.getElementById('gradeSelect');
  select.innerHTML = "";
  snapshot.docs.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.data().name;
    opt.textContent = d.data().name;
    select.appendChild(opt);
  });
}

// ğŸ‘¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function loadGroups(instituteId) {
  const q = query(collection(db, "groups"), where("instituteId", "==", instituteId));
  const snapshot = await getDocs(q);
  const select = document.getElementById('groupSelect');
  select.innerHTML = "";
  snapshot.docs.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.data().name;
    opt.textContent = d.data().name;
    select.appendChild(opt);
  });
}

// ğŸ‘©â€ğŸ« ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯
async function loadTeachers(instituteId) {
  const q = query(collection(db, "teachers"), where("instituteId", "==", instituteId));
  const snapshot = await getDocs(q);
  const select = document.getElementById('teacherSelect');
  select.innerHTML = "";
  snapshot.docs.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.data().name;
    opt.textContent = d.data().name;
    select.appendChild(opt);
  });
}

// â• Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³
window.addLesson = async function () {
  const subject = document.getElementById('subjectInput').value;
  const teacher = document.getElementById('teacherSelect').value;
  const grade = document.getElementById('gradeSelect').value;
  const group = document.getElementById('groupSelect').value;
  const day = document.getElementById('dayInput').value;
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  const studentsCount = parseInt(document.getElementById('studentsCount').value) || 0;

  if (!subject || !teacher || !grade || !group || !day || !startTime || !endTime) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  if (editingLessonId) {
    await updateDoc(doc(db, "lessons", editingLessonId), {
      subject, teacher, grade, group, day, startTime, endTime, studentsCount
    });
    alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­");
    editingLessonId = null;
    document.getElementById('addLessonBtn').textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³";
  } else {
    await addDoc(collection(db, "lessons"), {
      subject, teacher, grade, group, day, startTime, endTime, studentsCount,
      instituteId: currentUser.uid  // ğŸ‘ˆ Ø±Ø¨Ø· Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    });
    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­");
  }

  document.getElementById('lessonForm').reset();
  loadLessons(currentUser.uid);
};

// ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
async function loadLessons(instituteId) {
  const q = query(collection(db, "lessons"), where("instituteId", "==", instituteId));
  const snapshot = await getDocs(q);
  const tbody = document.querySelector("#lessonsTable tbody");
  tbody.innerHTML = "";
  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.subject}</td>
      <td>${d.teacher}</td>
      <td>${d.grade}</td>
      <td>${d.group}</td>
      <td>${d.day}</td>
      <td>${d.startTime} - ${d.endTime}</td>
      <td>${d.studentsCount}</td>
      <td>
        <button onclick="editLesson('${docSnap.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteLesson('${docSnap.id}')">Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// ğŸ—‘ï¸ Ø­Ø°Ù Ø¯Ø±Ø³
window.deleteLesson = async function (id) {
  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ")) {
    await deleteDoc(doc(db, "lessons", id));
    loadLessons(currentUser.uid);
  }
};

// âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³
window.editLesson = async function (id) {
  const q = doc(db, "lessons", id);
  const data = (await getDocs(collection(db, "lessons"))).docs.find(d => d.id === id)?.data();
  if (!data) return;

  document.getElementById('subjectInput').value = data.subject;
  document.getElementById('teacherSelect').value = data.teacher;
  document.getElementById('gradeSelect').value = data.grade;
  document.getElementById('groupSelect').value = data.group;
  document.getElementById('dayInput').value = data.day;
  document.getElementById('startTime').value = data.startTime;
  document.getElementById('endTime').value = data.endTime;
  document.getElementById('studentsCount').value = data.studentsCount;
  editingLessonId = id;
  document.getElementById('addLessonBtn').textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
};

// ğŸ–¨ï¸ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
window.printLessons = function () {
  const rows = Array.from(document.querySelectorAll("#lessonsTable tbody tr"));
  const printWindow = window.open('', 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³', 'width=900,height=600');
  printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</title>');
  printWindow.document.write('<style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;text-align:center;}th{background:#004aad;color:white;}</style></head><body>');
  printWindow.document.write('<h2 style="text-align:center">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³</h2>');
  printWindow.document.write('<table><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th></tr>');
  rows.forEach(r => { printWindow.document.write('<tr>' + r.innerHTML + '</tr>'); });
  printWindow.document.write('</table></body></html>');
  printWindow.document.close();
  printWindow.print();
}
</script>

<style>
body{font-family:'Cairo',sans-serif;background:#f5f9ff;margin:0;color:#1a1a1a;direction:rtl;}
header{background:#004aad;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;font-size:22px;}
header .logout-btn{background:#e53935;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;}
header .logout-btn:hover{background:#c62828;}
.container{max-width:1200px;margin:auto;padding:20px;}
form{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:20px;}
form input, form select{padding:8px;margin:5px;border-radius:5px;border:1px solid #ccc;}
form button{background:#004aad;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;transition:0.3s;}
form button:hover{background:#00337a;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-bottom:20px;}
th,td{padding:10px;border:1px solid #ddd;text-align:center;}
th{background:#004aad;color:white;}
.print-section, .search-section{margin-bottom:20px;}
footer{text-align:center;padding:15px;color:#777;font-size:14px;}
</style>
</head>
<body>

<header>
<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</h1>
<button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="container">

<form id="lessonForm" onsubmit="event.preventDefault(); addLesson();">
<h3>Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ / ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³</h3>
<input type="text" id="subjectInput" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©">
<select id="teacherSelect"></select>
<select id="gradeSelect"></select>
<select id="groupSelect"></select>
<input type="text" id="dayInput" placeholder="Ø§Ù„ÙŠÙˆÙ…">
<input type="time" id="startTime">
<input type="time" id="endTime">
<input type="number" id="studentsCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨">
<button type="submit" id="addLessonBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³</button>
</form>

<div class="print-section">
<h3>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</h3>
<button onclick="printLessons()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
</div>

<div class="table-container">
<table id="lessonsTable">
<thead>
<tr>
<th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
<th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
<th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
<th>Ø§Ù„ÙƒØ±ÙˆØ¨</th>
<th>Ø§Ù„ÙŠÙˆÙ…</th>
<th>Ø§Ù„ÙˆÙ‚Øª</th>
<th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<footer>
<p>Â© 2025 Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
</footer>

</body>
</html>
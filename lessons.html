<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
  authDomain: "oma-system-30813.firebaseapp.com",
  projectId: "oma-system-30813",
  storageBucket: "oma-system-30813.firebasestorage.app",
  messagingSenderId: "905224657062",
  appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
  measurementId: "G-645066LLLP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let editingLessonId = null;

onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById('userEmail').innerText = user.email;
    loadTeachers();
    loadGrades();
    loadGroups();
    loadLessons();
  } else {
    window.location.href = "login.html";
  }
});

window.logout = async function(){
  try { await signOut(auth); window.location.href = "login.html"; }
  catch(e){ console.error(e); }
}

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
let teachersList = [];
async function loadTeachers(){
  const snapshot = await getDocs(collection(db,"teachers"));
  teachersList = snapshot.docs.map(d=>d.data().name);
  const select = document.getElementById('teacherSelect');
  select.innerHTML = "";
  teachersList.forEach(t=>{ let opt = document.createElement("option"); opt.value=t; opt.textContent=t; select.appendChild(opt); });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
let gradesList = [];
async function loadGrades(){
  const snapshot = await getDocs(collection(db,"grades"));
  gradesList = snapshot.docs.map(d=>d.data().name);
  const select = document.getElementById('gradeSelect');
  select.innerHTML = "";
  gradesList.forEach(g=>{ let opt = document.createElement("option"); opt.value=g; opt.textContent=g; select.appendChild(opt); });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª
let groupsList = [];
async function loadGroups(){
  const snapshot = await getDocs(collection(db,"groups"));
  groupsList = snapshot.docs.map(d=>d.data().name);
  const select = document.getElementById('groupSelect');
  select.innerHTML = "";
  groupsList.forEach(g=>{ let opt = document.createElement("option"); opt.value=g; opt.textContent=g; select.appendChild(opt); });
}

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
window.addLesson = async function(){
  const subject = document.getElementById('subjectInput').value;
  const teacher = document.getElementById('teacherSelect').value;
  const grade = document.getElementById('gradeSelect').value;
  const group = document.getElementById('groupSelect').value;
  const day = document.getElementById('dayInput').value;
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  const studentsCount = Number(document.getElementById('studentsCount').value);

  if(!subject || !teacher || !grade || !group || !day || !startTime || !endTime){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  if(editingLessonId){
    await updateDoc(doc(db,"lessons",editingLessonId),{
      subject, teacher, grade, group, day, startTime, endTime, studentsCount
    });
    alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­");
    editingLessonId = null;
    document.getElementById('addLessonBtn').textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³";
  } else {
    await addDoc(collection(db,"lessons"),{
      subject, teacher, grade, group, day, startTime, endTime, studentsCount
    });
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­");
  }

  document.getElementById('lessonForm').reset();
  loadLessons();
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¯Ø±ÙˆØ³
async function loadLessons(){
  const snapshot = await getDocs(collection(db,"lessons"));
  const tbody = document.querySelector("#lessonsTable tbody");
  tbody.innerHTML = "";
  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.subject}</td>
      <td>${d.teacher}</td>
      <td>${d.grade}</td>
      <td>${d.group}</td>
      <td>${d.day}</td>
      <td>${d.startTime} - ${d.endTime}</td>
      <td>${d.studentsCount}</td>
      <td>
        <button onclick="editLesson('${docSnap.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteLesson('${docSnap.id}')">Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Ø­Ø°Ù Ø¯Ø±Ø³
window.deleteLesson = async function(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ")){
    await deleteDoc(doc(db,"lessons",id));
    loadLessons();
  }
}

// ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
window.editLesson = function(id){
  const tbody = document.querySelector("#lessonsTable tbody");
  let selectedRow;
  tbody.querySelectorAll("tr").forEach(r=>{
    if(r.querySelector("button").getAttribute("onclick").includes(id)){
      selectedRow = r;
    }
  });
  if(selectedRow){
    document.getElementById('subjectInput').value = selectedRow.children[0].textContent;
    document.getElementById('teacherSelect').value = selectedRow.children[1].textContent;
    document.getElementById('gradeSelect').value = selectedRow.children[2].textContent;
    document.getElementById('groupSelect').value = selectedRow.children[3].textContent;
    document.getElementById('dayInput').value = selectedRow.children[4].textContent;
    const times = selectedRow.children[5].textContent.split(" - ");
    document.getElementById('startTime').value = times[0];
    document.getElementById('endTime').value = times[1];
    document.getElementById('studentsCount').value = selectedRow.children[6].textContent;
    editingLessonId = id;
    document.getElementById('addLessonBtn').textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
  }
}

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³
window.printLessons = function(){
  const type = document.getElementById('printType').value;
  const filterValue = document.getElementById('printFilter').value.toLowerCase();
  let rows = Array.from(document.querySelectorAll("#lessonsTable tbody tr"));
  let filteredRows = [];

  if(type==="all"){ filteredRows = rows; }
  else if(type==="group"){ filteredRows = rows.filter(r=>r.children[3].textContent.toLowerCase()===filterValue); }
  else if(type==="teacher"){ filteredRows = rows.filter(r=>r.children[1].textContent.toLowerCase()===filterValue); }
  else if(type==="student"){ filteredRows = rows.filter(r=>r.children[6].textContent.toLowerCase()===filterValue); }

  let printWindow = window.open('','Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³','width=800,height=600');
  printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</title>');
  printWindow.document.write('<style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;text-align:center;}th{background:#004aad;color:white;}</style></head><body>');
  printWindow.document.write('<h2 style="text-align:center">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³</h2>');
  printWindow.document.write('<table><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th></tr>');
  filteredRows.forEach(r=>{ printWindow.document.write('<tr>'+r.innerHTML+'</tr>'); });
  printWindow.document.write('</table></body></html>');
  printWindow.document.close();
  printWindow.print();
}

// ÙÙ„ØªØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
const searchInput = document.getElementById('searchInput');
const searchField = document.getElementById('searchField');

searchInput.addEventListener('input', filterLessons);
searchField.addEventListener('change', filterLessons);

function filterLessons(){
  const term = searchInput.value.toLowerCase();
  const field = searchField.value;
  const rows = document.querySelectorAll('#lessonsTable tbody tr');

  rows.forEach(row=>{
    let cellValue = '';
    switch(field){
      case 'subject': cellValue = row.children[0].textContent; break;
      case 'teacher': cellValue = row.children[1].textContent; break;
      case 'grade': cellValue = row.children[2].textContent; break;
      case 'group': cellValue = row.children[3].textContent; break;
      case 'day': cellValue = row.children[4].textContent; break;
    }
    row.style.display = cellValue.toLowerCase().includes(term) ? '' : 'none';
  });
}
</script>

<style>
body{font-family:'Cairo',sans-serif;background:#f5f9ff;margin:0;color:#1a1a1a;direction:rtl;}
header{background:#004aad;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;font-size:22px;}
header .logout-btn{background:#e53935;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;}
header .logout-btn:hover{background:#c62828;}
.container{max-width:1200px;margin:auto;padding:20px;}
form{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:20px;}
form input, form select{padding:8px;margin:5px;border-radius:5px;border:1px solid #ccc;}
form button{background:#004aad;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;transition:0.3s;}
form button:hover{background:#00337a;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-bottom:20px;}
th,td{padding:10px;border:1px solid #ddd;text-align:center;}
th{background:#004aad;color:white;}
.print-section, .search-section{margin-bottom:20px;}
.print-section select, .print-section input, .print-section button,
.search-section select, .search-section input{padding:8px;margin:5px;border-radius:5px;border:1px solid #ccc;}
.print-section button{background:#ffcc33;cursor:pointer;}
.print-section button:hover{background:#e6b800;}
footer{text-align:center;padding:15px;color:#777;font-size:14px;}
</style>
</head>
<body>

<header>
<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</h1>
<button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="container">

<form id="lessonForm" onsubmit="event.preventDefault(); addLesson();">
<h3>Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ / ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø³</h3>
<input type="text" id="subjectInput" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©">
<select id="teacherSelect"></select>
<select id="gradeSelect"></select>
<select id="groupSelect"></select>
<input type="text" id="dayInput" placeholder="Ø§Ù„ÙŠÙˆÙ…">
<input type="time" id="startTime">
<input type="time" id="endTime">
<input type="number" id="studentsCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨">
<button type="submit" id="addLessonBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³</button>
</form>

<div class="search-section">
<label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹:</label>
<select id="searchField">
<option value="subject">Ø§Ù„Ù…Ø§Ø¯Ø©</option>
<option value="teacher">Ø§Ù„Ø£Ø³ØªØ§Ø°</option>
<option value="grade">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
<option value="group">Ø§Ù„ÙƒØ±ÙˆØ¨</option>
<option value="day">Ø§Ù„ÙŠÙˆÙ…</option>
</select>
<input type="text" id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù„Ù„Ø¨Ø­Ø«...">
</div>

<div class="print-section">
<h3>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</h3>
<select id="printType">
<option value="all">ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</option>
<option value="group">Ø¬Ø¯ÙˆÙ„ ÙƒØ±ÙˆØ¨</option>
<option value="teacher">Ø¬Ø¯ÙˆÙ„ Ø£Ø³ØªØ§Ø°</option>
<option value="student">Ø¬Ø¯ÙˆÙ„ Ø·Ø§Ù„Ø¨</option>
</select>
<input type="text" id="printFilter" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒØ±ÙˆØ¨">
<button onclick="printLessons()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<div class="table-container">
<table id="lessonsTable">
<thead>
<tr>
<th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
<th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
<th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
<th>Ø§Ù„ÙƒØ±ÙˆØ¨</th>
<th>Ø§Ù„ÙŠÙˆÙ…</th>
<th>Ø§Ù„ÙˆÙ‚Øª</th>
<th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<footer>
<p>Â© 2025 Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
</footer>

</body>
</html>

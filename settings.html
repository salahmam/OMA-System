<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إعدادات النظام - نظام أوما</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f5f9ff;
      margin: 0;
      padding: 20px;
      color: #1a1a1a;
    }

    header {
      background: #004aad;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .settings-container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2 { text-align: center; color: #004aad; margin-bottom: 20px; }
    .section { margin-bottom: 25px; }
    .section h3 { color: #004aad; margin-bottom: 10px; }

    label { display:block; margin-top: 10px; margin-bottom:5px; font-weight:600; }
    input, select { width: 100%; padding: 10px; border-radius:8px; border:1px solid #ccc; font-size:16px; }

    button {
      background-color: #004aad;
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      cursor:pointer;
      margin-top: 15px;
      font-size:16px;
      transition:0.3s;
    }

    button:hover { background-color: #00337a; }

    ul { list-style: none; padding:0; }
    ul li { padding:8px; background:#f1f3f6; margin-bottom:5px; border-radius:6px; display:flex; justify-content: space-between; align-items:center; }
    ul li button { background:#ff5722; padding:5px 10px; font-size:14px; }
  </style>
</head>
<body>

<header>
  <h1>إعدادات النظام - نظام أوما</h1>
</header>

<div class="settings-container">
  <h2>إعدادات المعهد</h2>

  <!-- معلومات المعهد -->
  <div class="section">
    <h3>معلومات المعهد</h3>
    <label>اسم المعهد:</label>
    <input type="text" id="instituteName" placeholder="أدخل اسم المعهد">

    <label>العنوان:</label>
    <input type="text" id="instituteAddress" placeholder="أدخل عنوان المعهد">

    <label>البريد الإلكتروني:</label>
    <input type="email" id="instituteEmail" placeholder="example@oma.com">

    <label>رقم الهاتف:</label>
    <input type="text" id="institutePhone" placeholder="077xxxxxxx">
  </div>

  <!-- المراحل الدراسية -->
  <div class="section">
    <h3>المراحل الدراسية</h3>
    <ul id="stagesList">
      <!-- سيتم ملء المراحل هنا من Firebase -->
    </ul>
    <input type="text" id="newStage" placeholder="اسم المرحلة الجديدة">
    <button onclick="addStage()">إضافة مرحلة جديدة</button>
  </div>

  <!-- إعدادات الحسابات -->
  <div class="section">
    <h3>إعدادات الحسابات</h3>
    <button onclick="changePassword()">تغيير كلمة المرور</button>
    <button onclick="manageUsers()">إدارة المستخدمين</button>
  </div>

  <!-- إعدادات الفواتير -->
  <div class="section">
    <h3>إعدادات الفواتير والمدفوعات</h3>
    <label>العملة:</label>
    <select id="currency">
      <option value="IQD">دينار عراقي</option>
      <option value="USD">دولار</option>
    </select>
  </div>

  <button onclick="saveSettings()">حفظ الإعدادات</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

  // إعدادات Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
    authDomain: "oma-system-30813.firebaseapp.com",
    projectId: "oma-system-30813",
    storageBucket: "oma-system-30813.appspot.com",
    messagingSenderId: "905224657062",
    appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
    measurementId: "G-645066LLLP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // التحقق من تسجيل الدخول
  onAuthStateChanged(auth, user => {
    if(!user) window.location.href = "login.html";
  });

  const settingsDoc = doc(db, "settings", "main"); // مستند رئيسي للإعدادات

  // تحميل الإعدادات من Firebase عند فتح الصفحة
  async function loadSettings() {
    const docSnap = await getDoc(settingsDoc);
    if(docSnap.exists()) {
      const data = docSnap.data();
      document.getElementById("instituteName").value = data.name || "";
      document.getElementById("instituteAddress").value = data.address || "";
      document.getElementById("instituteEmail").value = data.email || "";
      document.getElementById("institutePhone").value = data.phone || "";
      document.getElementById("currency").value = data.currency || "IQD";

      // المراحل
      const stagesList = document.getElementById("stagesList");
      stagesList.innerHTML = "";
      if(data.stages) {
        data.stages.forEach((stage,index)=>{
          const li = document.createElement("li");
          li.textContent = stage;
          const delBtn = document.createElement("button");
          delBtn.textContent = "حذف";
          delBtn.onclick = ()=>removeStage(stage);
          li.appendChild(delBtn);
          stagesList.appendChild(li);
        });
      }
    }
  }

  async function saveSettings() {
    await setDoc(settingsDoc, {
      name: document.getElementById("instituteName").value,
      address: document.getElementById("instituteAddress").value,
      email: document.getElementById("instituteEmail").value,
      phone: document.getElementById("institutePhone").value,
      currency: document.getElementById("currency").value
    }, { merge:true });
    alert("تم حفظ الإعدادات بنجاح");
  }

  async function addStage() {
    const newStage = document.getElementById("newStage").value.trim();
    if(!newStage) return;
    await updateDoc(settingsDoc, { stages: arrayUnion(newStage) });
    document.getElementById("newStage").value = "";
    loadSettings();
  }

  async function removeStage(stage) {
    await updateDoc(settingsDoc, { stages: arrayRemove(stage) });
    loadSettings();
  }

  // دوال الحسابات placeholder
  function changePassword() { alert("وظيفة تغيير كلمة المرور لم تنفذ بعد"); }
  function manageUsers() { alert("وظيفة إدارة المستخدمين لم تنفذ بعد"); }

  loadSettings(); // تحميل الإعدادات عند بدء الصفحة
</script>

</body>
</html>

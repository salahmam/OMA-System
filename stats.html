<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الإحصائيات - نظام أوما</title>
<link rel="stylesheet" href="style.css">

<style>
  body {
    font-family: 'Cairo', sans-serif;
    background: #f5f9ff;
    margin:0; padding:20px;
    color:#1a1a1a;
  }

  header {
    background:#004aad;
    color:white;
    padding:15px;
    text-align:center;
    border-radius:8px;
    margin-bottom:20px;
  }

  .stats-container {
    max-width:1200px;
    margin:auto;
    background:#fff;
    padding:25px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }

  h2 { text-align:center; color:#004aad; margin-bottom:20px; }

  .cards {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap:20px;
    margin-bottom:30px;
  }

  .card {
    background:#eaf1ff;
    padding:20px;
    border-radius:10px;
    text-align:center;
  }

  .card h3 { margin-bottom:10px; color:#004aad; }
  .card p { font-size:20px; font-weight:bold; }

  .charts {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:30px;
  }

  @media(max-width:900px){
    .charts { grid-template-columns:1fr; }
  }

  .filters {
    display:flex;
    gap:15px;
    margin-bottom:20px;
    flex-wrap:wrap;
  }

  .filters label { font-weight:600; margin-bottom:5px; display:block; }
  .filters input, .filters select, .filters button {
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:16px;
  }

  .filters button {
    background:#004aad;
    color:white;
    border:none;
    cursor:pointer;
    transition:0.3s;
  }

  .filters button:hover { background:#00337a; }
</style>
</head>
<body>

<header>
  <h1>الإحصائيات - نظام أوما</h1>
</header>

<div class="stats-container">

  <!-- فلترة الفترة الزمنية والمرحلة -->
  <div class="filters">
    <div>
      <label>من تاريخ:</label>
      <input type="date" id="startDate">
    </div>
    <div>
      <label>إلى تاريخ:</label>
      <input type="date" id="endDate">
    </div>
    <div>
      <label>المرحلة / الكروب:</label>
      <select id="groupFilter">
        <option value="all">الكل</option>
      </select>
    </div>
    <div style="align-self:end;">
      <button onclick="loadStats()">تحديث الإحصائيات</button>
    </div>
  </div>

  <!-- بطاقات الملخص -->
  <div class="cards">
    <div class="card">
      <h3>عدد الطلاب</h3>
      <p id="totalStudents">0</p>
    </div>
    <div class="card">
      <h3>عدد الأساتذة</h3>
      <p id="totalTeachers">0</p>
    </div>
    <div class="card">
      <h3>عدد الدروس اليوم</h3>
      <p id="lessonsToday">0</p>
    </div>
    <div class="card">
      <h3>المدفوع / المتبقي</h3>
      <p id="paymentsSummary">0 / 0</p>
    </div>
  </div>

  <!-- الرسوم البيانية -->
  <div class="charts">
    <canvas id="studentsByStageChart"></canvas>
    <canvas id="paymentsChart"></canvas>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

const firebaseConfig = {
  apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
  authDomain: "oma-system-30813.firebaseapp.com",
  projectId: "oma-system-30813",
  storageBucket: "oma-system-30813.appspot.com",
  messagingSenderId: "905224657062",
  appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
  measurementId: "G-645066LLLP"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

onAuthStateChanged(auth,user=>{
  if(!user) window.location.href="login.html";
});

// تحميل الكروبات للفلتر
async function loadGroups(){
  const groupSelect = document.getElementById("groupFilter");
  groupSelect.innerHTML='<option value="all">الكل</option>';
  const snapshot = await getDocs(collection(db,"students"));
  const groups = new Set();
  snapshot.forEach(doc=>{
    const data=doc.data();
    if(data.group) groups.add(data.group);
  });
  groups.forEach(g=>{
    const option = document.createElement("option");
    option.value=g; option.textContent=g;
    groupSelect.appendChild(option);
  });
}
loadGroups();

// رسم بياني للطلاب حسب المرحلة
let studentsByStageChart;
let paymentsChart;

async function loadStats(){
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const groupFilter = document.getElementById("groupFilter").value;

  // عدد الطلاب
  const studentsSnap = await getDocs(collection(db,"students"));
  let totalStudents=0;
  const stageCounts = {};
  studentsSnap.forEach(doc=>{
    const data=doc.data();
    if(groupFilter!=="all" && data.group!==groupFilter) return;
    totalStudents++;
    if(data.stage) stageCounts[data.stage]=(stageCounts[data.stage]||0)+1;
  });
  document.getElementById("totalStudents").textContent=totalStudents;

  // عدد الأساتذة
  const teachersSnap = await getDocs(collection(db,"teachers"));
  let totalTeachers=0;
  teachersSnap.forEach(doc=>{
    totalTeachers++;
  });
  document.getElementById("totalTeachers").textContent=totalTeachers;

  // عدد الدروس اليوم
  const lessonsSnap = await getDocs(collection(db,"lessons"));
  const today = new Date().toISOString().slice(0,10);
  let lessonsToday=0;
  lessonsSnap.forEach(doc=>{
    const data=doc.data();
    if(groupFilter!=="all" && data.group!==groupFilter) return;
    if(data.date===today) lessonsToday++;
  });
  document.getElementById("lessonsToday").textContent=lessonsToday;

  // المدفوع والمتبقي
  let totalPaid=0, totalRemaining=0;
  studentsSnap.forEach(doc=>{
    const data=doc.data();
    if(groupFilter!=="all" && data.group!==groupFilter) return;
    totalPaid+=Number(data.paid || 0);
    totalRemaining+=Number(data.remaining || 0);
  });
  document.getElementById("paymentsSummary").textContent=`${totalPaid} / ${totalRemaining}`;

  // الرسم البياني للطلاب حسب المرحلة
  const ctx1 = document.getElementById("studentsByStageChart").getContext("2d");
  if(studentsByStageChart) studentsByStageChart.destroy();
  studentsByStageChart = new Chart(ctx1,{
    type:"bar",
    data:{
      labels:Object.keys(stageCounts),
      datasets:[{
        label:"عدد الطلاب",
        data:Object.values(stageCounts),
        backgroundColor:"#004aad"
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false }, title:{ display:true, text:"الطلاب حسب المرحلة" } }
    }
  });

  // الرسم البياني للمدفوعات
  const ctx2 = document.getElementById("paymentsChart").getContext("2d");
  if(paymentsChart) paymentsChart.destroy();
  paymentsChart = new Chart(ctx2,{
    type:"bar",
    data:{
      labels:["المدفوع","المتبقي"],
      datasets:[{
        label:"المبالغ",
        data:[totalPaid,totalRemaining],
        backgroundColor:["#4caf50","#f44336"]
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false }, title:{ display:true, text:"المبالغ المالية" } }
    }
  });
}

loadStats();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>صفحة الطلاب</title>
<style>
body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(180deg, #ffffff, #f7f9fb);
    color: #1a1a1a;
    margin: 0;
    direction: rtl;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
}
th {
    background-color: #004aad;
    color: white;
}
button {
    padding: 5px 10px;
    margin: 2px;
    cursor: pointer;
}
</style>
</head>
<body>

<h1>قائمة الطلاب</h1>

<div>
    <label>المرحلة:
        <select id="filterStage">
            <option value="">الكل</option>
            <option value="أولى">أولى</option>
            <option value="ثانية">ثانية</option>
        </select>
    </label>
    <label>القسط:
        <select id="filterGroup">
            <option value="">الكل</option>
            <option value="أول">أول</option>
            <option value="ثاني">ثاني</option>
        </select>
    </label>
</div>

<p>عدد الطلاب: <span id="totalCount">0</span></p>

<table id="studentsTable">
<thead>
<tr>
    <th>الاسم</th>
    <th>المرحلة</th>
    <th>القسط</th>
    <th>الإجراءات</th>
</tr>
</thead>
<tbody>
<!-- سيتم ملؤها بالطلاب -->
</tbody>
</table>

<!-- نموذج تعديل الطالب -->
<div id="editFormDiv" style="display:none;">
<h2>تعديل بيانات الطالب</h2>
<form id="editForm">
    <input type="hidden" id="studentId">
    الاسم: <input type="text" id="editName" required><br><br>
    المرحلة: 
    <select id="editStage" required>
        <option value="أولى">أولى</option>
        <option value="ثانية">ثانية</option>
    </select><br><br>
    القسط: 
    <select id="editGroup" required>
        <option value="أول">أول</option>
        <option value="ثاني">ثاني</option>
    </select><br><br>
    <button type="submit">حفظ</button>
    <button type="button" id="cancelEdit">إلغاء</button>
</form>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// إعداد Firebase
const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const studentsTable = document.querySelector("#studentsTable tbody");
const totalCount = document.getElementById("totalCount");
const filterStage = document.getElementById("filterStage");
const filterGroup = document.getElementById("filterGroup");

let studentsData = [];

// تحميل الطلاب
async function loadStudents() {
    const querySnapshot = await getDocs(collection(db, "students"));
    studentsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderTable();
}

// عرض الطلاب حسب الفلاتر
function renderTable() {
    const stageVal = filterStage.value;
    const groupVal = filterGroup.value;

    const filtered = studentsData.filter(student => {
        return (!stageVal || student.stage === stageVal) &&
               (!groupVal || student.group === groupVal);
    });

    studentsTable.innerHTML = "";
    filtered.forEach(student => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${student.name}</td>
            <td>${student.stage}</td>
            <td>${student.group}</td>
            <td>
                <button onclick="editStudent('${student.id}')">تعديل</button>
                <button onclick="printStudent('${student.id}')">طباعة</button>
            </td>
        `;
        studentsTable.appendChild(row);
    });

    totalCount.innerText = filtered.length;
}

// الفلاتر
filterStage.addEventListener("change", renderTable);
filterGroup.addEventListener("change", renderTable);

// تعديل الطالب
const editFormDiv = document.getElementById("editFormDiv");
const editForm = document.getElementById("editForm");
const editName = document.getElementById("editName");
const editStage = document.getElementById("editStage");
const editGroup = document.getElementById("editGroup");
const studentIdInput = document.getElementById("studentId");

window.editStudent = function(id) {
    const student = studentsData.find(s => s.id === id);
    if (!student) return;
    studentIdInput.value = student.id;
    editName.value = student.name;
    editStage.value = student.stage;
    editGroup.value = student.group;
    editFormDiv.style.display = "block";
};

document.getElementById("cancelEdit").addEventListener("click", () => {
    editFormDiv.style.display = "none";
});

// حفظ التعديلات
editForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = studentIdInput.value;
    await updateDoc(doc(db, "students", id), {
        name: editName.value,
        stage: editStage.value,
        group: editGroup.value
    });
    loadStudents();
    editFormDiv.style.display = "none";
});

// طباعة طالب
window.printStudent = function(id) {
    const student = studentsData.find(s => s.id === id);
    if (!student) return;
    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
        <html>
        <head>
            <title>طباعة الطالب</title>
        </head>
        <body>
            <h2>معهدنا</h2>
            <p>الاسم: ${student.name}</p>
            <p>المرحلة: ${student.stage}</p>
            <p>القسط: ${student.group}</p>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
};

loadStudents();
</script>
</body>
</html>
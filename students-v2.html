<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
  authDomain: "oma-system-30813.firebaseapp.com",
  projectId: "oma-system-30813",
  storageBucket: "oma-system-30813.firebasestorage.app",
  messagingSenderId: "905224657062",
  appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
  measurementId: "G-645066LLLP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let editingStudentId = null;

onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById('userEmail').innerText = user.email;
    loadGrades();
    loadGroups();
    loadStudents();
  } else {
    window.location.href = "login.html";
  }
});

window.logout = async function(){
  try { await signOut(auth); window.location.href = "login.html"; }
  catch(e){ console.error(e); }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
let gradesList = [];
async function loadGrades(){
  const snapshot = await getDocs(collection(db,"grades"));
  gradesList = snapshot.docs.map(d=>d.data().name);
  const select = document.getElementById('gradeSelect');
  select.innerHTML = "";
  gradesList.forEach(g=>{ let opt = document.createElement("option"); opt.value=g; opt.textContent=g; select.appendChild(opt); });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª
let groupsList = [];
async function loadGroups(){
  const snapshot = await getDocs(collection(db,"groups"));
  groupsList = snapshot.docs.map(d=>d.data().name);
  const select = document.getElementById('groupSelect');
  select.innerHTML = "";
  groupsList.forEach(g=>{ let opt = document.createElement("option"); opt.value=g; opt.textContent=g; select.appendChild(opt); });
}

// Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
window.addStudent = async function(){
  const name = document.getElementById('nameInput').value;
  const grade = document.getElementById('gradeSelect').value;
  const group = document.getElementById('groupSelect').value;
  const phone = document.getElementById('phoneInput').value;

  if(!name || !grade || !group){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  if(editingStudentId){
    await updateDoc(doc(db,"students",editingStudentId),{name, grade, group, phone});
    editingStudentId = null;
    document.getElementById('addStudentBtn').textContent = "â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨";
  } else {
    await addDoc(collection(db,"students"),{name, grade, group, phone});
  }

  document.getElementById('studentForm').reset();
  loadStudents();
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadStudents(){
  const snapshot = await getDocs(collection(db,"students"));
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  snapshot.forEach(docSnap=>{
    const d = docSnap.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.name}</td>
      <td>${d.grade}</td>
      <td>${d.group}</td>
      <td>${d.phone || ''}</td>
      <td>
        <button onclick="editStudent('${docSnap.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteStudent('${docSnap.id}')">Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Ø­Ø°Ù Ø·Ø§Ù„Ø¨
window.deleteStudent = async function(id){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")){
    await deleteDoc(doc(db,"students",id));
    loadStudents();
  }
}

// ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
window.editStudent = function(id){
  const tbody = document.querySelector("#studentsTable tbody");
  let selectedRow;
  tbody.querySelectorAll("tr").forEach(r=>{
    if(r.querySelector("button").getAttribute("onclick").includes(id)){
      selectedRow = r;
    }
  });
  if(selectedRow){
    document.getElementById('nameInput').value = selectedRow.children[0].textContent;
    document.getElementById('gradeSelect').value = selectedRow.children[1].textContent;
    document.getElementById('groupSelect').value = selectedRow.children[2].textContent;
    document.getElementById('phoneInput').value = selectedRow.children[3].textContent;
    editingStudentId = id;
    document.getElementById('addStudentBtn').textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
  }
}

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
window.printStudents = function(){
  let rows = Array.from(document.querySelectorAll("#studentsTable tbody tr"));
  let printWindow = window.open('','Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨','width=800,height=600');
  printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>');
  printWindow.document.write('<style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;text-align:center;}th{background:#004aad;color:white;}</style></head><body>');
  printWindow.document.write('<h2 style="text-align:center">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>');
  printWindow.document.write('<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th></tr>');
  rows.forEach(r=>{ printWindow.document.write('<tr>'+r.innerHTML+'</tr>'); });
  printWindow.document.write('</table></body></html>');
  printWindow.document.close();
  printWindow.print();
}

// ÙÙ„ØªØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
const searchInput = document.getElementById('searchInput');
const searchField = document.getElementById('searchField');

searchInput.addEventListener('input', filterStudents);
searchField.addEventListener('change', filterStudents);

function filterStudents(){
  const term = searchInput.value.toLowerCase();
  const field = searchField.value;
  const rows = document.querySelectorAll('#studentsTable tbody tr');

  rows.forEach(row=>{
    let cellValue = '';
    switch(field){
      case 'name': cellValue = row.children[0].textContent; break;
      case 'grade': cellValue = row.children[1].textContent; break;
      case 'group': cellValue = row.children[2].textContent; break;
      case 'phone': cellValue = row.children[3].textContent; break;
    }
    row.style.display = cellValue.toLowerCase().includes(term) ? '' : 'none';
  });
}
</script>

<style>
body{font-family:'Cairo',sans-serif;background:#f5f9ff;margin:0;color:#1a1a1a;direction:rtl;}
header{background:#004aad;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;font-size:22px;}
header .logout-btn{background:#e53935;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;}
header .logout-btn:hover{background:#c62828;}
.container{max-width:1200px;margin:auto;padding:20px;}
form{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:20px;}
form input, form select{padding:8px;margin:5px;border-radius:5px;border:1px solid #ccc;}
form button{background:#004aad;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;transition:0.3s;}
form button:hover{background:#00337a;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-bottom:20px;}
th,td{padding:10px;border:1px solid #ddd;text-align:center;}
th{background:#004aad;color:white;}
.print-section, .search-section{margin-bottom:20px;}
.print-section select, .print-section input, .print-section button,
.search-section select, .search-section input{padding:8px;margin:5px;border-radius:5px;border:1px solid #ccc;}
.print-section button{background:#ffcc33;cursor:pointer;}
.print-section button:hover{background:#e6b800;}
footer{text-align:center;padding:15px;color:#777;font-size:14px;}
</style>
</head>
<body>

<header>
<h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</h1>
<button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<div class="container">

<form id="studentForm" onsubmit="event.preventDefault(); addStudent();">
<h3>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ / ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</h3>
<input type="text" id="nameInput" placeholder="Ø§Ù„Ø§Ø³Ù…">
<select id="gradeSelect"></select>
<select id="groupSelect"></select>
<input type="text" id="phoneInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
<button type="submit" id="addStudentBtn">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
</form>

<div class="search-section">
<label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹:</label>
<select id="searchField">
<option value="name">Ø§Ù„Ø§Ø³Ù…</option>
<option value="grade">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
<option value="group">Ø§Ù„ÙƒØ±ÙˆØ¨</option>
<option value="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</option>
</select>
<input type="text" id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù„Ù„Ø¨Ø­Ø«...">
</div>

<div class="print-section">
<h3>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
<button onclick="printStudents()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
</div>

<div class="table-container">
<table id="studentsTable">
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
<th>Ø§Ù„ÙƒØ±ÙˆØ¨</th>
<th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<footer>
<p>Â© 2025 Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
</footer>

</body>
</html>
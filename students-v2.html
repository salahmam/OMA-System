<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - OMA</title>

<!-- ØªØµÙ…ÙŠÙ… Ø³Ø±ÙŠØ¹ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨ -->
<style>
  :root{
    --primary:#004aad;
    --accent:#ffcc33;
    --bg:#f5f9ff;
    --card:#fff;
  }
  *{box-sizing:border-box}
  body{
    font-family: 'Cairo',sans-serif;
    margin:0;background:linear-gradient(180deg,var(--bg),#fff);
    color:#102027;direction:rtl;
  }
  header{
    background:linear-gradient(90deg,var(--primary),#007bff);
    color:#fff;padding:18px 16px;text-align:center;font-size:20px;font-weight:700;
    box-shadow:0 3px 12px rgba(2,20,40,0.08);
  }
  .wrap{max-width:1200px;margin:22px auto;padding:12px;}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;align-items:center;}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);flex:1}
  .form-grid{display:flex;flex-wrap:wrap;gap:10px}
  input[type="text"], input[type="tel"], input[type="number"], select, textarea, .subject-field {
    padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;
  }
  .two{width:calc(50% - 6px)}
  .three{width:calc(33.333% - 8px)}
  label{display:block;margin-bottom:6px;font-size:13px;color:#37474f}
  .btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.warn{background:#ff7043}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
  .add-subj{display:inline-block;margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
  th{background:var(--primary);color:#fff}
  .actions button{margin:0 6px}
  .small{padding:6px 8px;font-size:13px;border-radius:6px}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;align-items:center}
  .checkbox{width:18px;height:18px}
  /* responsive */
  @media (max-width:900px){
    .two,.three{width:100%}
    .controls{flex-direction:column;align-items:stretch}
  }
  /* print styles A4 */
  @media print{
    body{background:white;padding:0}
    header, .controls, .card .form-grid, .filters, .actions{display:none}
    .print-page{box-shadow:none;margin:0;padding:0}
  }
  /* modal */
  .modal { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999;}
  .modal.open{display:flex}
  .modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto}
  .flex{display:flex;gap:8px;align-items:center}
  .logo-preview{height:60px;object-fit:contain}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©)</header>

<div class="wrap">

  <div class="controls">
    <div style="flex:1" class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
          <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
        </div>

        <div class="right">
          <button id="openLogoBtn" class="btn ghost">Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
          <input id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." style="padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
          <button id="refreshBtn" class="btn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <form id="studentForm" style="margin-top:12px">
        <div class="form-grid">
          <div class="two">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input id="name" type="text" required />
          </div>
          <div class="two">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
            <input id="phone" type="tel" required />
          </div>
          <div class="two">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="address" type="text" />
          </div>
          <div class="two">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label>
            <input id="school" type="text" />
          </div>
          <div class="two">
            <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
            <input id="stage" type="text" />
          </div>
          <div class="two">
            <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label>
            <input id="group" type="text" placeholder="Ù…Ø«Ø§Ù„: A Ø£Ùˆ 101" />
          </div>

          <div style="width:100%">
            <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø©)</label>
            <div id="subjectsContainer" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            <div style="margin-top:8px">
              <button id="addSubjectBtn" type="button" class="btn ghost small add-subj">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
            </div>
          </div>

          <div class="two">
            <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="totalFees" type="number" min="0" />
          </div>
          <div class="two">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <input id="note" type="text" />
          </div>

          <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
            <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
        </div>
      </form>
    </div>

    <div style="min-width:320px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Ø·Ø¨Ø§Ø¹Ø© / ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</strong>
          <div style="font-size:13px;color:#546e7a">Ø­Ø¯Ø¯ Ø´Ø±ÙˆØ· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø§Ø®ØªÙØ± Ø·Ø¨Ø§Ø¹Ø© Ù…ÙØµÙ„Ø© Ù„Ø·Ø§Ù„Ø¨</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="filterStage" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
          </select>
          <select id="filterGroup" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
          </select>
          <select id="filterInstallment" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
            <option value="">ÙƒÙ„ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·</option>
            <option value="1">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£ÙˆÙ„</option>
            <option value="2">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            <option value="3">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«</option>
            <option value="4">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
          </select>
          <button id="printSelectedBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
          <button id="printFilteredBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</strong> <span id="totalCount" class="badge">0</span></div>
      <div style="display:flex;align-items:center;gap:8px">
        <label style="font-size:13px">Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù…Ø§Ø¹ÙŠ</label>
        <input id="selectAll" type="checkbox" class="checkbox" />
      </div>
    </div>

    <table id="studentsTable">
      <thead>
        <tr>
          <th></th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø§Ù„Ù…ÙˆØ§Ø¯</th>
          <th>Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø¹Ø¯Ø¯)</th>
          <th>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- Modal: student detail / add installment -->
<div id="modal" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
      <button id="closeModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Modal: Upload logo -->
<div id="logoModal" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong>Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</strong>
      <button id="closeLogoModal" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div>
      <input id="logoInput" type="file" accept="image/*" />
      <div style="margin-top:12px">
        <img id="logoPreview" class="logo-preview" src="" alt="logo preview" />
      </div>
      <div style="margin-top:12px">
        <button id="uploadLogoBtn" class="btn">Ø±ÙØ¹ ÙˆØ­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v10 modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

  // === Ø¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ (Ù†ÙØ³ Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹) ===
  const firebaseConfig = {
    apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
    authDomain: "oma-system-30813.firebaseapp.com",
    projectId: "oma-system-30813",
    storageBucket: "oma-system-30813.firebasestorage.app",
    messagingSenderId: "905224657062",
    appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
    measurementId: "G-645066LLLP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const subjectsContainer = document.getElementById('subjectsContainer');
  const addSubjectBtn = document.getElementById('addSubjectBtn');
  const form = document.getElementById('studentForm');
  const tableBody = document.querySelector('#studentsTable tbody');
  const searchInput = document.getElementById('searchInput');
  const refreshBtn = document.getElementById('refreshBtn');
  const totalCount = document.getElementById('totalCount');
  const selectAll = document.getElementById('selectAll');
  const filterStage = document.getElementById('filterStage');
  const filterGroup = document.getElementById('filterGroup');
  const filterInstallment = document.getElementById('filterInstallment');
  const printSelectedBtn = document.getElementById('printSelectedBtn');
  const printFilteredBtn = document.getElementById('printFilteredBtn');

  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modalBody');
  const modalTitle = document.getElementById('modalTitle');
  const closeModal = document.getElementById('closeModal');

  // logo modal elements
  const logoModal = document.getElementById('logoModal');
  const openLogoBtn = document.getElementById('openLogoBtn');
  const closeLogoModal = document.getElementById('closeLogoModal');
  const logoInput = document.getElementById('logoInput');
  const uploadLogoBtn = document.getElementById('uploadLogoBtn');
  const logoPreview = document.getElementById('logoPreview');

  let currentLogoUrl = null;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù†Ø¶Ù…Ù† Ø£Ù† ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù… ÙŠØ¯Ø®Ù„ÙˆÙ†)
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      // Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ù‹Ø§ â€” Ø£Ø¹Ø¯ ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
      window.location.href = "login.html";
    } else {
      // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯ (Ø¥Ù† ÙˆÙØ¬Ø¯)
      loadLogoUrl();
    }
  });

  // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù…Ø§Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠ
  function addSubjectField(value = '') {
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.className = 'subject-field';
    inp.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©';
    inp.value = value;
    subjectsContainer.appendChild(inp);
  }
  addSubjectField();

  addSubjectBtn.addEventListener('click', ()=> addSubjectField());

  // ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ù…Ù† doc settings/logo
  async function loadLogoUrl(){
    try {
      const docRef = doc(db, 'settings', 'logo');
      const snap = await getDoc(docRef);
      if (snap.exists()){
        currentLogoUrl = snap.data().url || null;
        if(currentLogoUrl) logoPreview.src = currentLogoUrl;
      }
    } catch(e){
      console.error('loadLogoUrl', e);
    }
  }

  // Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Firebase Storage ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Firestore
  openLogoBtn.addEventListener('click', ()=> logoModal.classList.add('open'));
  closeLogoModal.addEventListener('click', ()=> logoModal.classList.remove('open'));

  uploadLogoBtn.addEventListener('click', async ()=>{
    const file = logoInput.files[0];
    if(!file){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const path = `logos/institute_logo_${Date.now()}_${file.name}`;
    const storageRef = sRef(storage, path);
    try {
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      // Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Firestore
      await setDoc(doc(db, 'settings', 'logo'), { url });
      currentLogoUrl = url;
      logoPreview.src = url;
      alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­');
      logoModal.classList.remove('open');
    } catch(e){
      console.error(e); alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±');
    }
  });

  // Ø­ÙØ¸ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const school = document.getElementById('school').value.trim();
    const stage = document.getElementById('stage').value.trim();
    const group = document.getElementById('group').value.trim();
    const totalFees = parseFloat(document.getElementById('totalFees').value) || 0;
    const note = document.getElementById('note').value.trim();
    const subjects = Array.from(document.querySelectorAll('.subject-field')).map(i=>i.value).filter(Boolean);

    if(!name || !phone){
      alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');
      return;
    }

    await addDoc(collection(db, 'students'), {
      name, phone, address, school, stage, group, subjects, totalFees, installments: [], note, createdAt: new Date()
    });

    form.reset();
    subjectsContainer.innerHTML = '';
    addSubjectField();
    loadStudents();
  });

  // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
  document.getElementById('clearFormBtn').addEventListener('click', ()=>{
    form.reset(); subjectsContainer.innerHTML=''; addSubjectField();
  });

  // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
  async function loadStudents(){
    tableBody.innerHTML = '';
    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
    const q = query(collection(db, 'students'), orderBy('createdAt','desc'));
    const snapshot = await getDocs(q);
    const docs = [];
    const stagesSet = new Set();
    const groupsSet = new Set();

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      docs.push({ id: docSnap.id, ...data });
      if(data.stage) stagesSet.add(data.stage);
      if(data.group) groupsSet.add(data.group);
    });

    // ØªØ­Ø¯ÙŠØ« ÙÙŠÙ„ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    populateFilterOptions(Array.from(stagesSet).sort(), Array.from(groupsSet).sort());

    // ØªØµÙÙŠÙ‡ Ù…Ø­Ù„ÙŠÙ‡ ÙˆÙÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ±
    const search = searchInput.value.trim().toLowerCase();
    const stageFilter = filterStage.value;
    const groupFilter = filterGroup.value;
    const installmentFilter = filterInstallment.value ? parseInt(filterInstallment.value) : null;

    const filtered = docs.filter(s=>{
      if(search){
        if(!(s.name?.toLowerCase().includes(search) || s.phone?.toLowerCase().includes(search) || (s.school||'').toLowerCase().includes(search))) return false;
      }
      if(stageFilter && s.stage !== stageFilter) return false;
      if(groupFilter && s.group !== groupFilter) return false;
      if(installmentFilter){
        // show only those who have installment at that index (1-based)
        if(!(Array.isArray(s.installments) && s.installments.length >= installmentFilter)) return false;
      }
      return true;
    });

    totalCount.innerText = filtered.length;

    filtered.forEach(s=>{
      const tr = document.createElement('tr');
      const subjText = s.subjects && s.subjects.length ? s.subjects.join('ØŒ ') : '-';
      const instCount = (s.installments && s.installments.length) ? s.installments.length : 0;
      tr.innerHTML = `
        <td><input type="checkbox" class="sel" data-id="${s.id}"/></td>
        <td style="text-align:right">${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.phone)}</td>
        <td>${escapeHtml(s.stage||'-')}</td>
        <td>${escapeHtml(s.group||'-')}</td>
        <td style="text-align:right">${escapeHtml(subjText)}</td>
        <td>${instCount}</td>
        <td class="actions">
          <button class="btn ghost small" data-id="${s.id}" data-action="view">Ø¹Ø±Ø¶</button>
          <button class="btn small" data-id="${s.id}" data-action="install">â• Ù‚Ø³Ø·</button>
          <button class="btn" data-id="${s.id}" data-action="print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn warn small" data-id="${s.id}" data-action="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn warn small" data-id="${s.id}" data-action="delete">Ø­Ø°Ù</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    tableBody.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', handleRowAction);
    });

    // checkbox handlers
    selectAll.checked = false;
    selectAll.onchange = ()=> {
      document.querySelectorAll('.sel').forEach(cb=> cb.checked = selectAll.checked);
    };
  }

  // Ù…Ø³Ø§Ø¹Ø¯Ø© escape
  function escapeHtml(s){ return (s===null||s===undefined)?'':String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Ù…Ù„Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±
  function populateFilterOptions(stages, groups){
    filterStage.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>';
    stages.forEach(s=> {
      const o = document.createElement('option'); o.value = s; o.textContent = s; filterStage.appendChild(o);
    });
    filterGroup.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>';
    groups.forEach(g=> {
      const o = document.createElement('option'); o.value = g; o.textContent = g; filterGroup.appendChild(o);
    });
  }

  // ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙ
  async function handleRowAction(e){
    const id = e.currentTarget.dataset.id;
    const action = e.currentTarget.dataset.action;
    if(action === 'delete'){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) return;
      await deleteDoc(doc(db,'students',id));
      loadStudents();
    } else if(action === 'view'){
      showStudentDetail(id);
    } else if(action === 'install'){
      addInstallmentForStudent(id);
    } else if(action === 'print'){
      printSingleStudent(id);
    } else if(action === 'edit'){
      editStudent(id);
    }
  }

  // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ù„Ø·Ø§Ù„Ø¨
  async function addInstallmentForStudent(id){
    const amount = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø· (Ù…Ø«Ù„Ø§Ù‹: 50000)');
    if(!amount) return;
    const note = prompt('Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù‚Ø³Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)');
    const ref = doc(db,'students',id);
    const snap = await getDoc(ref);
    const data = snap.data();
    const installing = data.installments ? [...data.installments] : [];
    installing.push({ amount: parseFloat(amount), date: new Date().toLocaleDateString(), note: note || '' });
    await updateDoc(ref, { installments: installing });
    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø·');
    loadStudents();
  }

  // Ø·Ø¨Ø§Ø¹Ø© Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ (ØµÙØ­Ø© A4 Ø±Ø³Ù…ÙŠØ© Ù…Ø¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯)
  async function printSingleStudent(id){
    const ref = doc(db,'students',id);
    const snap = await getDoc(ref);
    if(!snap.exists()) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const s = snap.data();

    // logo
    let logoHtml = '';
    const logoDoc = await getDoc(doc(db,'settings','logo'));
    const logoUrl = logoDoc.exists() ? logoDoc.data().url : null;
    if(logoUrl) logoHtml = `<div style="text-align:center;margin-bottom:8px"><img src="${logoUrl}" style="max-height:80px;object-fit:contain" /></div>`;

    const installmentsRows = (s.installments||[]).map(i=>`<tr><td style="border:1px solid #333;padding:6px;text-align:center">${i.date}</td><td style="border:1px solid #333;padding:6px;text-align:center">${i.amount}</td><td style="border:1px solid #333;padding:6px;text-align:center">${escapeHtml(i.note||'')}</td></tr>`).join('');

    const html = `
      <html lang="ar" dir="rtl"><head>
        <meta charset="utf-8">
        <title>Ø¨ÙŠØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ - ${escapeHtml(s.name)}</title>
        <style>
          @page { size: A4; margin: 24mm; }
          body{font-family: 'Cairo',sans-serif; color:#102027}
          h1{color:#004aad;text-align:center;margin-bottom:4px}
          .meta{margin-bottom:12px}
          table{width:100%;border-collapse:collapse;margin-top:8px}
          th,td{border:1px solid #333;padding:8px;text-align:center}
          .footer{margin-top:20px;text-align:right;font-size:13px}
        </style>
      </head><body>
        ${logoHtml}
        <h1>Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
        <div class="meta">
          <table>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><td>${escapeHtml(s.name)}</td><th>Ø§Ù„Ù‡Ø§ØªÙ</th><td>${escapeHtml(s.phone)}</td></tr>
            <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td>${escapeHtml(s.address||'-')}</td><th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><td>${escapeHtml(s.school||'-')}</td></tr>
            <tr><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><td>${escapeHtml(s.stage||'-')}</td><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><td>${escapeHtml(s.group||'-')}</td></tr>
            <tr><th>Ø§Ù„Ù…ÙˆØ§Ø¯</th><td colspan="3">${(s.subjects||[]).map(x=>escapeHtml(x)).join('ØŒ ')}</td></tr>
          </table>
        </div>

        <h2 style="color:#004aad">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h2>
        <table>
          <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
          ${installmentsRows || '<tr><td colspan="3" style="text-align:center;padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø· Ù…Ø³Ø¬Ù„Ø©</td></tr>'}
        </table>

        <div class="footer">
          <div style="margin-top:30px">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: ____________________</div>
        </div>
        <script>window.print();</script>
      </body></html>
    `;
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
  }

  // Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ù…ÙÙ„ØªØ±Ø© / Ù…Ø®ØªØ§Ø±Ø©
  async function printList(studentsArray, options = {}) {
    // options: {installmentIndex: 1|null, title}
    const logoDoc = await getDoc(doc(db,'settings','logo'));
    const logoUrl = logoDoc.exists() ? logoDoc.data().url : null;
    const logoHtml = logoUrl ? `<div style="text-align:center;margin-bottom:6px"><img src="${logoUrl}" style="max-height:60px;object-fit:contain" /></div>` : '';
    const rows = studentsArray.map(s=>{
      // installment column depends on installmentIndex (1-based)
      let instVal = '-';
      if(options.installmentIndex){
        const idx = options.installmentIndex - 1;
        instVal = (s.installments && s.installments[idx]) ? s.installments[idx].amount : '-';
      } else {
        instVal = (s.installments && s.installments.length) ? s.installments.length : 0;
      }
      return `<tr>
        <td style="border:1px solid #333;padding:6px;text-align:center">${escapeHtml(s.name)}</td>
        <td style="border:1px solid #333;padding:6px;text-align:center">${escapeHtml(s.phone)}</td>
        <td style="border:1px solid #333;padding:6px;text-align:center">${escapeHtml(s.stage||'-')}</td>
        <td style="border:1px solid #333;padding:6px;text-align:center">${escapeHtml(s.group||'-')}</td>
        <td style="border:1px solid #333;padding:6px;text-align:center">${Array.isArray(s.subjects)?escapeHtml(s.subjects.join('ØŒ ')) : '-'}</td>
        <td style="border:1px solid #333;padding:6px;text-align:center">${instVal}</td>
      </tr>`;
    }).join('');

    const html = `
      <html lang="ar" dir="rtl"><head>
        <meta charset="utf-8">
        <title>${options.title || 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨'}</title>
        <style>
          @page { size: A4; margin: 18mm; }
          body{font-family:'Cairo',sans-serif;color:#102027}
          h1{color:#004aad;text-align:center}
          table{width:100%;border-collapse:collapse;margin-top:8px}
          th,td{border:1px solid #333;padding:8px;text-align:center}
          th{background:#004aad;color:#fff}
        </style>
      </head><body>
        ${logoHtml}
        <h1>${options.title || 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨'}</h1>
        <table>
          <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯</th><th>${options.installmentIndex ? 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· ' + options.installmentIndex : 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·'}</th></tr>
          ${rows || '<tr><td colspan="6" style="text-align:center;padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>'}
        </table>
        <script>window.print()</script>
      </body></html>
    `;
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
  }

  // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ (selected)
  printSelectedBtn.addEventListener('click', async ()=>{
    const ids = Array.from(document.querySelectorAll('.sel:checked')).map(cb=>cb.dataset.id);
    if(ids.length === 0){ alert('Ù„Ù… ØªØ®ØªÙØ± Ø·Ù„Ø§Ø¨Ø§Ù‹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
    const docs = [];
    for(const id of ids){
      const snap = await getDoc(doc(db,'students',id));
      if(snap.exists()) docs.push({ id: snap.id, ...snap.data() });
    }
    // Ø§Ù„Ø®ÙŠØ§Ø±: Ø¥Ø°Ø§ Ø§Ø®ØªÙŠØ± Ù‚Ø³Ø· Ù…Ø¹ÙŠÙ† ÙÙŠ Ø§Ù„ÙÙ„ØªØ± Ù†Ø·Ø¨Ø¹Ù‡ ÙƒÙ‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    const instIdx = filterInstallment.value ? parseInt(filterInstallment.value) : null;
    await printList(docs, { installmentIndex: instIdx, title: 'Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨' });
  });

  // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  printFilteredBtn.addEventListener('click', async ()=>{
    // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø·Ø¨Ù‚Ù†Ø§ ÙÙ„ØªØ± Ù…Ø­Ù„ÙŠ)
    const q = query(collection(db, 'students'), orderBy('createdAt','desc'));
    const snapshot = await getDocs(q);
    const docs = [];
    snapshot.forEach(d=> docs.push({ id: d.id, ...d.data() }));
    const search = searchInput.value.trim().toLowerCase();
    const stageF = filterStage.value;
    const groupF = filterGroup.value;
    const instIdx = filterInstallment.value ? parseInt(filterInstallment.value) : null;
    const filtered = docs.filter(s=>{
      if(search && !(s.name?.toLowerCase().includes(search) || s.phone?.toLowerCase().includes(search))) return false;
      if(stageF && s.stage !== stageF) return false;
      if(groupF && s.group !== groupF) return false;
      if(instIdx && !(Array.isArray(s.installments) && s.installments.length >= instIdx)) return false;
      return true;
    });
    if(filtered.length === 0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±'); return; }
    await printList(filtered, { installmentIndex: instIdx, title: 'Ù‚Ø§Ø¦Ù…Ø© Ø·Ø¨Ø§Ø¹Ø©' });
  });

  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· ÙˆØªØ­Ø±ÙŠØ±
  async function showStudentDetail(id){
    const snap = await getDoc(doc(db,'students',id));
    if(!snap.exists()) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const s = snap.data();
    modalTitle.innerText = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨: ' + s.name;
    modalBody.innerHTML = `
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:240px">
          <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
          <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(s.name)}</p>
          <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${escapeHtml(s.phone)}</p>
          <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${escapeHtml(s.address||'-')}</p>
          <p><strong>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</strong> ${escapeHtml(s.school||'-')}</p>
          <p><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${escapeHtml(s.stage||'-')}</p>
          <p><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> ${escapeHtml(s.group||'-')}</p>
        </div>
        <div style="flex:1;min-width:240px">
          <h3>Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
          <div>${(s.subjects||[]).map(x=>`<div class="badge">${escapeHtml(x)}</div>`).join(' ') || '-'}</div>
          <h3 style="margin-top:12px">Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
          <div id="installList">
            ${(s.installments||[]).map(i=>`<div style="padding:6px;border-bottom:1px solid #eee"><strong>${escapeHtml(i.date)}</strong> â€” ${escapeHtml(i.amount)} â€” ${escapeHtml(i.note||'')}</div>`).join('') || '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ø·</div>'}
          </div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="addInstBtn" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø·</button>
        <button id="printSingle" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    `;
    modal.classList.add('open');

    document.getElementById('addInstBtn').addEventListener('click', async ()=>{
      const amt = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø³Ø·:');
      if(!amt) return;
      const note = prompt('Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù‚Ø³Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';
      const ref = doc(db,'students',id);
      const snap2 = await getDoc(ref);
      const data2 = snap2.data();
      const insts = data2.installments ? [...data2.installments, { amount: parseFloat(amt), date: new Date().toLocaleDateString(), note }] : [{ amount: parseFloat(amt), date: new Date().toLocaleDateString(), note}];
      await updateDoc(ref, { installments: insts });
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ø·');
      modal.classList.remove('open');
      loadStudents();
    });

    document.getElementById('printSingle').addEventListener('click', ()=> printSingleStudent(id));
  }

  closeModal.addEventListener('click', ()=> modal.classList.remove('open'));

  // ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨
  async function editStudent(id){
    const snap = await getDoc(doc(db,'students',id));
    if(!snap.exists()) return alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const s = snap.data();
    // Ù†Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('name').value = s.name || '';
    document.getElementById('phone').value = s.phone || '';
    document.getElementById('address').value = s.address || '';
    document.getElementById('school').value = s.school || '';
    document.getElementById('stage').value = s.stage || '';
    document.getElementById('group').value = s.group || '';
    document.getElementById('totalFees').value = s.totalFees || '';
    document.getElementById('note').value = s.note || '';
    subjectsContainer.innerHTML = '';
    (s.subjects || []).forEach(sub => addSubjectField(sub));
    // Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù† Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø¨Ø¯Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    const saveBtn = document.getElementById('saveStudentBtn');
    saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
    const handler = async function handleUpdate(e){
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const school = document.getElementById('school').value.trim();
      const stage = document.getElementById('stage').value.trim();
      const group = document.getElementById('group').value.trim();
      const totalFees = parseFloat(document.getElementById('totalFees').value) || 0;
      const note = document.getElementById('note').value.trim();
      const subjects = Array.from(document.querySelectorAll('.subject-field')).map(i=>i.value).filter(Boolean);
      await updateDoc(doc(db,'students',id), { name, phone, address, school, stage, group, totalFees, note, subjects });
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
      saveBtn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨';
      form.removeEventListener('submit', handler);
      form.addEventListener('submit', formSubmitHandler);
      form.reset(); subjectsContainer.innerHTML=''; addSubjectField();
      loadStudents();
    };
    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹
    form.removeEventListener('submit', formSubmitHandler);
    form.addEventListener('submit', handler);
  }

  // Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠ handler Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø±ÙŠØ±
  async function formSubmitHandler(e){
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const school = document.getElementById('school').value.trim();
    const stage = document.getElementById('stage').value.trim();
    const group = document.getElementById('group').value.trim();
    const totalFees = parseFloat(document.getElementById('totalFees').value) || 0;
    const note = document.getElementById('note').value.trim();
    const subjects = Array.from(document.querySelectorAll('.subject-field')).map(i=>i.value).filter(Boolean);
    await addDoc(collection(db, 'students'), { name, phone, address, school, stage, group, subjects, totalFees, installments: [], note, createdAt: new Date() });
    form.reset(); subjectsContainer.innerHTML=''; addSubjectField(); loadStudents();
  }
  // attach original
  form.addEventListener('submit', formSubmitHandler);

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
  searchInput.addEventListener('input', ()=> loadStudents());
  refreshBtn.addEventListener('click', ()=> loadStudents());
  filterStage.addEventListener('change', ()=> loadStudents());
  filterGroup.addEventListener('change', ()=> loadStudents());
  filterInstallment.addEventListener('change', ()=> loadStudents());

  // initial load
  await loadStudents();

  // helper: load logo preview if exists
  if(currentLogoUrl) logoPreview.src = currentLogoUrl;

  // Ø­Ø¯Ø« Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ preview Ù…Ø­Ù„ÙŠ
  logoInput.addEventListener('change', (e)=> {
    const f = e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    logoPreview.src = url;
  });

</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - OMA</title>

<style>
  :root{
    --primary:#004aad;
    --accent:#ffcc33;
    --bg:#f5f9ff;
    --card:#fff;
  }
  *{box-sizing:border-box}
  body{
    font-family: 'Cairo',sans-serif;
    margin:0;background:linear-gradient(180deg,var(--bg),#fff);
    color:#102027;direction:rtl;
  }
  header{
    background:linear-gradient(90deg,var(--primary),#007bff);
    color:#fff;padding:18px 16px;text-align:center;font-size:20px;font-weight:700;
    box-shadow:0 3px 12px rgba(2,20,40,0.08);
  }
  .wrap{max-width:1200px;margin:22px auto;padding:12px;}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;align-items:center;}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(6,20,30,0.06);flex:1}
  .form-grid{display:flex;flex-wrap:wrap;gap:10px}
  input[type="text"], input[type="tel"], input[type="number"], select, textarea, .subject-field {
    padding:10px;border:1px solid #d6dde9;border-radius:8px;font-size:15px;width:100%;
  }
  .two{width:calc(50% - 6px)}
  .three{width:calc(33.333% - 8px)}
  label{display:block;margin-bottom:6px;font-size:13px;color:#37474f}
  .btn{background:var(--primary);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.warn{background:#ff7043}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,74,173,0.12)}
  .add-subj{display:inline-block;margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
  th{background:var(--primary);color:#fff}
  .actions button{margin:0 6px}
  .small{padding:6px 8px;font-size:13px;border-radius:6px}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:700}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;align-items:center}
  .checkbox{width:18px;height:18px}
  @media (max-width:900px){
    .two,.three{width:100%}
    .controls{flex-direction:column;align-items:stretch}
  }
  @media print{
    body{background:white;padding:0}
    header, .controls, .card .form-grid, .filters, .actions{display:none}
    .print-page{box-shadow:none;margin:0;padding:0}
  }
  .modal { position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999;}
  .modal.open{display:flex}
  .modal .box{background:white;padding:18px;border-radius:10px;max-width:720px;width:94%;max-height:90vh;overflow:auto}
  .flex{display:flex;gap:8px;align-items:center}
  .logo-preview{height:60px;object-fit:contain}
</style>
</head>
<body>
<header>Ù†Ø¸Ø§Ù… OMA - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©)</header>

<div class="wrap">
  <div class="controls">
    <!-- Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
    <div style="flex:1" class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <strong>Ø£Ø¶Ù Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</strong>
          <div style="font-size:13px;color:#546e7a">Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
        </div>
        <div class="right">
          <button id="openLogoBtn" class="btn ghost">Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</button>
          <input id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." style="padding:8px;border-radius:8px;border:1px solid #e0e6ef" />
          <button id="refreshBtn" class="btn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>

      <form id="studentForm" style="margin-top:12px">
        <div class="form-grid">
          <div class="two"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="name" type="text" required /></div>
          <div class="two"><label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="phone" type="tel" required /></div>
          <div class="two"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="address" type="text" /></div>
          <div class="two"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="school" type="text" /></div>
          <div class="two"><label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label><input id="stage" type="text" /></div>
          <div class="two"><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„ÙƒØ±ÙˆØ¨</label><input id="group" type="text" placeholder="Ù…Ø«Ø§Ù„: A Ø£Ùˆ 101" /></div>

          <div style="width:100%">
            <label>Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø£Ø¶Ù Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø©)</label>
            <div id="subjectsContainer" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            <div style="margin-top:8px">
              <button id="addSubjectBtn" type="button" class="btn ghost small add-subj">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
            </div>
          </div>

          <div class="two"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="totalFees" type="number" min="0" /></div>
          <div class="two"><label>Ù…Ù„Ø§Ø­Ø¸Ø© / ÙˆØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨</label><input id="note" type="text" /></div>

          <div style="width:100%;display:flex;gap:8px;justify-content:flex-end">
            <button id="saveStudentBtn" class="btn" type="submit">âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            <button id="clearFormBtn" type="button" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
        </div>
      </form>
    </div>

    <!-- ÙÙ„ØªØ±Ø© / Ø·Ø¨Ø§Ø¹Ø© -->
    <div style="min-width:320px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Ø·Ø¨Ø§Ø¹Ø© / ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</strong>
          <div style="font-size:13px;color:#546e7a">Ø­Ø¯Ø¯ Ø´Ø±ÙˆØ· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø§Ø®ØªÙØ± Ø·Ø¨Ø§Ø¹Ø© Ù…ÙØµÙ„Ø© Ù„Ø·Ø§Ù„Ø¨</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="filterStage" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option></select>
          <select id="filterGroup" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option></select>
          <select id="filterInstallment" style="padding:8px;border-radius:8px;border:1px solid #e0e6ef">
            <option value="">ÙƒÙ„ Ø§Ù„Ø§Ù‚Ø³Ø§Ø·</option>
            <option value="1">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£ÙˆÙ„</option>
            <option value="2">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
            <option value="3">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø«Ø§Ù„Ø«</option>
            <option value="4">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
          </select>
          <button id="printSelectedBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
          <button id="printFilteredBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div class="card" style="margin-top:12px;overflow-x:auto">
    <table id="studentsTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" class="checkbox" /></th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
          <th>Ø§Ù„Ù…ÙˆØ§Ø¯</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div style="margin-top:8px;font-size:13px">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="totalCount">0</span></div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø¹Ø§Ø± -->
<div class="modal" id="logoModal">
  <div class="box">
    <h3>Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯</h3>
    <input type="file" id="logoInput" accept="image/*"/>
    <div style="margin-top:12px"><img id="logoPreview" class="logo-preview"/></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="saveLogoBtn" class="btn">Ø­ÙØ¸</button>
      <button id="closeLogoBtn" class="btn ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script type="module">
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
import { setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = { /* Ø¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Ø¹Ù†Ø§ØµØ± DOM
const tableBody = document.getElementById('tableBody');
const studentForm = document.getElementById('studentForm');
const saveStudentBtn = document.getElementById('saveStudentBtn');
const subjectsContainer = document.getElementById('subjectsContainer');
const addSubjectBtn = document.getElementById('addSubjectBtn');
const searchInput = document.getElementById('searchInput');
const filterStage = document.getElementById('filterStage');
const filterGroup = document.getElementById('filterGroup');
const filterInstallment = document.getElementById('filterInstallment');
const totalCount = document.getElementById('totalCount');
const selectAll = document.getElementById('selectAll');
const refreshBtn = document.getElementById('refreshBtn');
const logoModal = document.getElementById('logoModal');
const logoInput = document.getElementById('logoInput');
const logoPreview = document.getElementById('logoPreview');
const openLogoBtn = document.getElementById('openLogoBtn');
const closeLogoBtn = document.getElementById('closeLogoBtn');
const saveLogoBtn = document.getElementById('saveLogoBtn');

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
function escapeHtml(text){ return text ? text.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ''; }
function addSubjectField(value=''){ 
  const input = document.createElement('input');
  input.type='text'; input.className='subject-field'; input.value=value; input.placeholder='Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©';
  subjectsContainer.appendChild(input);
}

// ÙØªØ­ / ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø¹Ø§Ø±
openLogoBtn.onclick = ()=>logoModal.classList.add('open');
closeLogoBtn.onclick = ()=>logoModal.classList.remove('open');
logoInput.onchange = e=>{
  const file = e.target.files[0];
  if(file) logoPreview.src = URL.createObjectURL(file);
}

// Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±
saveLogoBtn.onclick = async ()=>{
  if(!logoInput.files[0]) return alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø©');
  const file = logoInput.files[0];
  const logoRef = ref(storage,'institute-logo/'+file.name);
  await uploadBytes(logoRef,file);
  const url = await getDownloadURL(logoRef);
  await setDoc(doc(db,'config','logo'),{url});
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±'); logoModal.classList.remove('open'); logoPreview.src='';
}

// Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
document.getElementById('clearFormBtn').onclick = ()=>{
  studentForm.reset();
  subjectsContainer.innerHTML='';
  addSubjectField();
  saveStudentBtn.textContent='âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨';
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©
addSubjectBtn.onclick = ()=>addSubjectField();

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
async function loadStudents(){
  tableBody.innerHTML=''; 
  try{
    const q=query(collection(db,'students'),orderBy('createdAt','desc'));
    const snapshot=await getDocs(q);
    const docs=[]; const stagesSet=new Set(); const groupsSet=new Set();
    snapshot.forEach(docSnap=>{
      const data=docSnap.data();
      docs.push({id:docSnap.id,...data});
      if(data.stage) stagesSet.add(data.stage);
      if(data.group) groupsSet.add(data.group);
    });
    populateFilterOptions(Array.from(stagesSet).sort(),Array.from(groupsSet).sort());
    const search=searchInput.value.trim().toLowerCase();
    const stageFilter=filterStage.value;
    const groupFilter=filterGroup.value;
    const installmentFilter=filterInstallment.value ? parseInt(filterInstallment.value) : null;
    const filtered=docs.filter(s=>{
      if(search && !(s.name?.toLowerCase().includes(search) || s.phone?.toLowerCase().includes(search) || (s.school||'').toLowerCase().includes(search))) return false;
      if(stageFilter && s.stage!==stageFilter) return false;
      if(groupFilter && s.group!==groupFilter) return false;
      if(installmentFilter){ if(!(Array.isArray(s.installments) && s.installments.length>=installmentFilter)) return false; }
      return true;
    });
    totalCount.innerText=filtered.length;
    filtered.forEach(s=>{
      const tr=document.createElement('tr');
      const subjText=s.subjects && s.subjects.length ? s.subjects.join('ØŒ ') : '-';
      const instCount=(s.installments && s.installments.length) ? s.installments.length : 0;
      tr.innerHTML=`
        <td><input type="checkbox" class="sel" data-id="${s.id}"/></td>
        <td style="text-align:right">${escapeHtml(s.name)}</td>
        <td>${escapeHtml(s.phone)}</td>
        <td>${escapeHtml(s.stage||'-')}</td>
        <td>${escapeHtml(s.group||'-')}</td>
        <td style="text-align:right">${escapeHtml(subjText)}</td>
        <td>${instCount}</td>
        <td class="actions">
          <button class="btn ghost small" data-id="${s.id}" data-action="view">Ø¹Ø±Ø¶</button>
          <button class="btn small" data-id="${s.id}" data-action="install">â• Ù‚Ø³Ø·</button>
          <button class="btn" data-id="${s.id}" data-action="print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn warn small" data-id="${s.id}" data-action="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn warn small" data-id="${s.id}" data-action="delete">Ø­Ø°Ù</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
    tableBody.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',handleRowAction));
    selectAll.checked=false;
    selectAll.onchange=()=>{document.querySelectorAll('.sel').forEach(cb=>cb.checked=selectAll.checked);}
  }catch(err){console.error('loadStudents error:',err);}
}

function populateFilterOptions(stages,groups){
  filterStage.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>';
  stages.forEach(s=>filterStage.innerHTML+=`<option value="${s}">${s}</option>`);
  filterGroup.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>';
  groups.forEach(g=>filterGroup.innerHTML+=`<option value="${g}">${g}</option>`);
}

// Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
studentForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  if(!name||!phone){alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨');return;}
  const address=document.getElementById('address').value.trim();
  const school=document.getElementById('school').value.trim();
  const stage=document.getElementById('stage').value.trim();
  const group=document.getElementById('group').value.trim();
  const totalFees=parseFloat(document.getElementById('totalFees').value)||0;
  const note=document.getElementById('note').value.trim();
  const subjects=Array.from(document.querySelectorAll('.subject-field')).map(i=>i.value).filter(Boolean);
  await addDoc(collection(db,'students'),{name,phone,address,school,stage,group,subjects,totalFees,installments:[],note,createdAt:new Date()});
  studentForm.reset(); subjectsContainer.innerHTML=''; addSubjectField();
  loadStudents();
});

searchInput.oninput=loadStudents;
filterStage.onchange=loadStudents;
filterGroup.onchange=loadStudents;
filterInstallment.onchange=loadStudents;
refreshBtn.onclick=loadStudents;

// ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
addSubjectField();
loadStudents();

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙÙˆÙ
async function handleRowAction(e){
  const id=e.target.dataset.id;
  const action=e.target.dataset.action;
  if(action==='delete'){if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')){await deleteDoc(doc(db,'students',id)); loadStudents();}}
  else if(action==='edit'){editStudent(id);}
  else if(action==='view'){alert('Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨');}
  else if(action==='install'){alert('Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ø· Ù„Ù„Ø·Ø§Ù„Ø¨');}
  else if(action==='print'){alert('Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');}
}

// ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨
async function editStudent(id){
  const snap=await getDoc(doc(db,'students',id));
  if(!snap.exists()){alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return;}
  const s=snap.data();
  document.getElementById('name').value=s.name||'';
  document.getElementById('phone').value=s.phone||'';
  document.getElementById('address').value=s.address||'';
  document.getElementById('school').value=s.school||'';
  document.getElementById('stage').value=s.stage||'';
  document.getElementById('group').value=s.group||'';
  document.getElementById('totalFees').value=s.totalFees||'';
  document.getElementById('note').value=s.note||'';
  subjectsContainer.innerHTML=''; (s.subjects||[]).forEach(sub=>addSubjectField(sub));
  saveStudentBtn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  studentForm.replaceWith(studentForm.cloneNode(true));
  const newForm=document.getElementById('studentForm');
  newForm.addEventListener('submit',async e=>{
    e.preventDefault();
    const name=document.getElementById('name').value.trim();
    const phone=document.getElementById('phone').value.trim();
    const address=document.getElementById('address').value.trim();
    const school=document.getElementById('school').value.trim();
    const stage=document.getElementById('stage').value.trim();
    const group=document.getElementById('group').value.trim();
    const totalFees=parseFloat(document.getElementById('totalFees').value)||0;
    const note=document.getElementById('note').value.trim();
    const subjects=Array.from(document.querySelectorAll('.subject-field')).map(i=>i.value).filter(Boolean);
    await updateDoc(doc(db,'students',id),{name,phone,address,school,stage,group,totalFees,note,subjects});
    alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
    saveStudentBtn.textContent='âœ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨';
    loadStudents();
    newForm.reset(); subjectsContainer.innerHTML=''; addSubjectField();
    newForm.addEventListener('submit',e=>studentForm.dispatchEvent(new Event('submit')));// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ
  });
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAEMoMQDiLffCCJWybFJFQ-b9iHajimme0",
  authDomain: "oma-system-30813.firebaseapp.com",
  projectId: "oma-system-30813",
  storageBucket: "oma-system-30813.firebasestorage.app",
  messagingSenderId: "905224657062",
  appId: "1:905224657062:web:584b3e72e4cc2c58ea3c67",
  measurementId: "G-645066LLLP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
  if(user){
    document.getElementById('userEmail').innerText = user.email;
    loadTeachers();
  } else {
    alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    window.location.href = "login.html";
  }
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
window.logout = async function(){
  try{
    await signOut(auth);
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
    window.location.href = "login.html";
  } catch(error){
    console.error(error);
  }
};

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
async function loadTeachers(){
  const teachersCol = collection(db, "teachers");
  const snapshot = await getDocs(teachersCol);
  const tbody = document.querySelector("#teachersTable tbody");
  tbody.innerHTML = "";

  snapshot.forEach(docSnap => {
    const teacher = docSnap.data();
    const total = Number(teacher.totalSalary) || 0;
    const payments = teacher.payments || [];
    const paid = payments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
    const remaining = total - paid;
    const groups = teacher.groups || [];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${teacher.name}</td>
      <td>${teacher.subject}</td>
      <td>${teacher.phone || '-'}</td>
      <td>${groups.join(", ") || '-'}</td>
      <td>${total.toLocaleString()}</td>
      <td>${paid.toLocaleString()}</td>
      <td>${remaining.toLocaleString()}</td>
      <td>
        <button onclick="addPayment('${docSnap.id}')">â• Ø¯ÙØ¹Ø©</button>
        <button onclick="editTeacher('${docSnap.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteTeacher('${docSnap.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        <button onclick="addGroup('${docSnap.id}')">â• ÙƒØ±ÙˆØ¨</button>
        <button onclick="printTeacherForm('${docSnap.id}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
async function addPayment(id){
  const amount = parseFloat(prompt("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:"));
  if(!amount || isNaN(amount)) return alert("Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­");

  const date = new Date().toISOString().split('T')[0];
  const teacherRef = doc(db, "teachers", id);
  const teacherSnap = await getDoc(teacherRef);
  const payments = teacherSnap.data().payments || [];
  payments.push({ amount: Number(amount), date });
  await updateDoc(teacherRef, { payments });
  loadTeachers();
}

// Ø¥Ø¶Ø§ÙØ© ÙƒØ±ÙˆØ¨ Ø¬Ø¯ÙŠØ¯
async function addGroup(id){
  const groupName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
  if(!groupName) return;
  const teacherRef = doc(db, "teachers", id);
  const teacherSnap = await getDoc(teacherRef);
  const groups = teacherSnap.data().groups || [];
  groups.push(groupName);
  await updateDoc(teacherRef, { groups });
  loadTeachers();
}

// ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³ØªØ§Ø°
async function editTeacher(id){
  const teacherRef = doc(db, "teachers", id);
  const teacherSnap = await getDoc(teacherRef);
  if(teacherSnap.exists()){
    const teacher = teacherSnap.data();
    const newName = prompt("Ø§Ù„Ø§Ø³Ù…:", teacher.name);
    const newSubject = prompt("Ø§Ù„Ù…Ø§Ø¯Ø©:", teacher.subject);
    const newPhone = prompt("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:", teacher.phone || '');
    const newTotal = parseFloat(prompt("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚:", teacher.totalSalary));
    if(newName && newSubject && !isNaN(newTotal)){
      await updateDoc(teacherRef, { name:newName, subject:newSubject, phone:newPhone, totalSalary:Number(newTotal) });
      loadTeachers();
    }
  }
}

// Ø­Ø°Ù Ø£Ø³ØªØ§Ø°
async function deleteTeacher(id){
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³ØªØ§Ø°ØŸ")){
    await deleteDoc(doc(db, "teachers", id));
    loadTeachers();
  }
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯
async function submitAddTeacher(){
  const name = document.getElementById("teacherName").value.trim();
  const subject = document.getElementById("teacherSubject").value.trim();
  const phone = document.getElementById("teacherPhone").value.trim();
  const totalSalary = parseFloat(document.getElementById("teacherSalary").value);
  const groupsInput = document.getElementById("teacherGroups").value.trim();
  const groups = groupsInput ? groupsInput.split(",").map(g=>g.trim()) : [];

  if(!name || !subject || !phone || isNaN(totalSalary)){
    return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
  }

  await addDoc(collection(db, "teachers"), {
    name,
    subject,
    phone,
    totalSalary: Number(totalSalary),
    payments: [],
    groups
  });

  loadTeachers();
  document.getElementById("teacherName").value = "";
  document.getElementById("teacherSubject").value = "";
  document.getElementById("teacherPhone").value = "";
  document.getElementById("teacherSalary").value = "";
  document.getElementById("teacherGroups").value = "";
}

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø£Ø³ØªØ§Ø°
async function printTeacherForm(id){
  const teacherRef = doc(db, "teachers", id);
  const teacherSnap = await getDoc(teacherRef);
  if(!teacherSnap.exists()) return alert("Ø§Ù„Ù…Ø¹Ù„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  const teacher = teacherSnap.data();
  const total = Number(teacher.totalSalary) || 0;
  const payments = teacher.payments || [];
  const paid = payments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
  const remaining = total - paid;
  const groups = teacher.groups || [];

  let paymentsRows = "";
  payments.forEach(p => {
    paymentsRows += `<tr><td>${p.date}</td><td>${Number(p.amount).toLocaleString()}</td></tr>`;
  });

  const content = `
  <html>
  <head>
    <title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø£Ø³ØªØ§Ø° ${teacher.name}</title>
    <style>
      body { font-family:'Cairo', sans-serif; direction:rtl; margin:20px; }
      h2, h3 { text-align:center; }
      table { width:100%; border-collapse: collapse; margin-top:10px; }
      th, td { border:1px solid #000; padding:8px; text-align:center; }
      th { background:#004aad; color:white; }
      @media print { @page { size:A4; margin:20mm; } }
    </style>
  </head>
  <body>
    <h2>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°</h2>
    <h3>${teacher.name}</h3>
    <p><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${teacher.subject}</p>
    <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${teacher.phone || '-'}</p>
    <p><strong>Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª:</strong> ${groups.join(", ") || '-'}</p>
    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${total.toLocaleString()}</p>
    <p><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paid.toLocaleString()}</p>
    <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${remaining.toLocaleString()}</p>

    <h3>Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3>
    <table>
      <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>
      ${paymentsRows || '<tr><td colspan="2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª</td></tr>'}
    </table>
  </body>
  </html>
  `;

  const newWin = window.open("");
  newWin.document.write(content);
  newWin.document.close();
  newWin.focus();
  newWin.print();
}
</script>

<style>
body { font-family:'Cairo',sans-serif; background:linear-gradient(180deg,#fff,#eaf1ff); margin:0; color:#1a1a1a; direction:rtl; }
header { background:#004aad; color:white; padding:15px; text-align:center; }
.container { max-width:1100px; margin:auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:10px; border:1px solid #ddd; text-align:center; }
th { background:#004aad; color:white; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; margin:2px; transition:0.3s; }
button:hover{opacity:0.8;}
.logout-btn{background:#e53935;color:white;margin-bottom:10px;}
#addTeacherForm{background:#f1f3f6;padding:15px;border-radius:8px;margin-top:15px; display:block;}
#addTeacherForm input{padding:5px;margin:5px 0;width:100%;}
#addTeacherForm button{margin-top:5px;}
#printFilter{margin-top:10px;}
#printFilter input{padding:5px;margin:0 5px;}
</style>
</head>
<body>

<header><h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© - Ù†Ø¸Ø§Ù… Ø£ÙˆÙ…Ø§</h1></header>

<div class="container">
<p>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="userEmail">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></p>
<button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° -->
<div id="addTeacherForm">
<h3>Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</h3>
<label>Ø§Ù„Ø§Ø³Ù…: <input type="text" id="teacherName"></label><br>
<label>Ø§Ù„Ù…Ø§Ø¯Ø©: <input type="text" id="teacherSubject"></label><br>
<label>Ø§Ù„Ù‡Ø§ØªÙ: <input type="text" id="teacherPhone"></label><br>
<label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <input type="number" id="teacherSalary"></label><br>
<label>Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©): <input type="text" id="teacherGroups"></label><br>
<button onclick="submitAddTeacher()">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<!-- Ø¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div id="printFilter">
<label>Ù…Ù†: <input type="date" id="fromDate"></label>
<label>Ø¥Ù„Ù‰: <input type="date" id="toDate"></label>
<button onclick="alert('ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø§Ø­Ù‚Ø§Ù‹')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
</div>

<table id="teachersTable">
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒØ±ÙˆØ¨Ø§Øª</th>
<th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody>
<!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
</tbody>
</table>
</div>

</body>
</html>